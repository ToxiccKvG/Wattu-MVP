// @generated by Cursor AI (Claude) â€” verified by Kevin Mendy
import { createContext, useContext, useState, useEffect, useCallback } from 'react';
import { useTranslation } from 'react-i18next';

/**
 * Context pour la gestion globale de la langue (FR / Wolof)
 * 
 * RÃ´le :
 * - Stocke la langue actuelle ('fr' ou 'wo')
 * - Se connecte Ã  i18next pour synchroniser les traductions
 * - Permet de changer la langue (pour citoyens)
 * - Permet de forcer la langue (pour login, agents, admins)
 * 
 * Usage :
 * 1. Wrapper l'app avec <LangProvider>
 * 2. Utiliser le hook useLanguage() dans n'importe quel composant
 * 
 * Exemple :
 * const { language, changeLanguage } = useLanguage();
 */

// CrÃ©ation du Context
const LangContext = createContext(null);

/**
 * Provider du Context de langue
 * 
 * @param {Object} props
 * @param {ReactNode} props.children - Composants enfants
 */
export function LangProvider({ children }) {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // HOOKS & Ã‰TAT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  // Hook i18next pour accÃ©der aux fonctions de traduction
  const { i18n } = useTranslation();
  
  /**
   * Langue actuelle
   * SynchronisÃ©e avec i18next
   */
  const [language, setLanguage] = useState(i18n.language || 'fr');

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // FONCTIONS DE GESTION DE LA LANGUE
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Change la langue et la sauvegarde dans localStorage
   * 
   * UtilisÃ© par : Citoyens (via LanguageSwitcher)
   * 
   * Process :
   * 1. Appelle i18n.changeLanguage() pour changer les traductions
   * 2. i18next sauvegarde automatiquement dans localStorage
   * 3. Met Ã  jour l'Ã©tat React
   * 
   * @param {string} lang - Code langue ('fr' | 'wo')
   * 
   * Exemple :
   * changeLanguage('wo'); // Passe en Wolof
   * changeLanguage('fr'); // Passe en FranÃ§ais
   * 
   * Note : Utilise useCallback pour Ã©viter les re-renders inutiles
   */
  const changeLanguage = useCallback(async (lang) => {
    try {
      // VÃ©rifier que la langue est supportÃ©e
      if (!['fr', 'wo'].includes(lang)) {
        console.warn(`Langue non supportÃ©e: ${lang}. Utilisation de 'fr' par dÃ©faut.`);
        lang = 'fr';
      }

      // Changer la langue dans i18next (+ sauvegarde localStorage)
      await i18n.changeLanguage(lang);
      
      // Mettre Ã  jour l'Ã©tat React
      setLanguage(lang);
      
      console.log(`âœ… Langue changÃ©e: ${lang}`);
    } catch (error) {
      console.error('Erreur changement langue:', error);
    }
  }, [i18n]);

  /**
   * Force la langue temporairement (SANS sauvegarde localStorage)
   * 
   * UtilisÃ© par : Login, Agent Dashboard, Admin Dashboard
   * 
   * Process :
   * 1. Change la langue dans i18next SANS sauvegarde
   * 2. Met Ã  jour l'Ã©tat React
   * 3. Quand le user revient sur une page publique, sa langue sauvegardÃ©e est restaurÃ©e
   * 
   * @param {string} lang - Code langue ('fr' | 'wo')
   * 
   * Exemple :
   * forceLanguage('fr'); // Force le franÃ§ais (temporaire)
   * 
   * Note : Utilise useCallback pour Ã©viter les re-renders inutiles
   */
  const forceLanguage = useCallback(async (lang) => {
    try {
      // VÃ©rifier que la langue est supportÃ©e
      if (!['fr', 'wo'].includes(lang)) {
        console.warn(`Langue non supportÃ©e: ${lang}. Utilisation de 'fr' par dÃ©faut.`);
        lang = 'fr';
      }

      // Changer la langue dans i18next SANS modifier localStorage
      // (on ne veut pas Ã©craser le choix du citoyen)
      await i18n.changeLanguage(lang);
      
      // Mettre Ã  jour l'Ã©tat React
      setLanguage(lang);
      
      console.log(`ğŸ”’ Langue forcÃ©e (temporaire): ${lang}`);
    } catch (error) {
      console.error('Erreur forÃ§age langue:', error);
    }
  }, [i18n]);

  /**
   * Restaure la langue sauvegardÃ©e du user
   * 
   * UtilisÃ© quand on revient sur une page publique aprÃ¨s Ãªtre passÃ©
   * par une page avec langue forcÃ©e (ex: login â†’ home)
   * 
   * Process :
   * 1. RÃ©cupÃ¨re la langue sauvegardÃ©e dans localStorage
   * 2. Change i18next vers cette langue
   * 3. Met Ã  jour l'Ã©tat React
   * 
   * Note : Utilise useCallback pour Ã©viter les re-renders inutiles
   * (critique pour Ã©viter les boucles infinies dans PublicLayout)
   */
  const restoreLanguage = useCallback(async () => {
    try {
      // RÃ©cupÃ©rer la langue sauvegardÃ©e (clÃ© dÃ©finie dans i18n.js)
      const savedLang = localStorage.getItem('wattu_language') || 'fr';
      
      // Restaurer la langue sauvegardÃ©e
      await i18n.changeLanguage(savedLang);
      setLanguage(savedLang);
      
      console.log(`ğŸ”„ Langue restaurÃ©e: ${savedLang}`);
    } catch (error) {
      console.error('Erreur restauration langue:', error);
    }
  }, [i18n]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // EFFETS (useEffect)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  /**
   * Effet : Synchroniser l'Ã©tat React quand i18next change
   * 
   * i18next peut changer de langue via :
   * - DÃ©tection automatique au chargement
   * - Changement depuis un autre composant
   * - Restauration depuis localStorage
   * 
   * On Ã©coute ces changements pour garder React synchronisÃ©
   */
  useEffect(() => {
    const handleLanguageChanged = (lng) => {
      console.log(`ğŸŒ i18next language changed: ${lng}`);
      setLanguage(lng);
    };

    // Ã‰couter les changements de langue i18next
    i18n.on('languageChanged', handleLanguageChanged);

    // Initialiser avec la langue actuelle de i18next
    setLanguage(i18n.language);

    // Cleanup : ArrÃªter d'Ã©couter quand le composant est dÃ©montÃ©
    return () => {
      i18n.off('languageChanged', handleLanguageChanged);
    };
  }, [i18n]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // VALEURS DU CONTEXT (accessibles via useLanguage())
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const value = {
    // Ã‰tat
    language,                           // 'fr' | 'wo'
    availableLanguages: ['fr', 'wo'],   // Langues disponibles
    
    // Fonctions
    changeLanguage,                     // Changer langue (avec sauvegarde)
    forceLanguage,                      // Forcer langue (temporaire)
    restoreLanguage,                    // Restaurer langue sauvegardÃ©e
    
    // Helpers
    isFrench: language === 'fr',        // true si franÃ§ais
    isWolof: language === 'wo',         // true si Wolof
    languageLabel: language === 'fr' ? 'FranÃ§ais' : 'Wolof', // Label pour affichage
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  return (
    <LangContext.Provider value={value}>
      {children}
    </LangContext.Provider>
  );
}

/**
 * Hook personnalisÃ© pour accÃ©der au Context de langue
 * 
 * Usage :
 * const { language, changeLanguage, forceLanguage } = useLanguage();
 * 
 * @returns {Object} Valeurs et fonctions du context
 * @throws {Error} Si utilisÃ© hors d'un LangProvider
 * 
 * Exemple :
 * function MyComponent() {
 *   const { language, changeLanguage } = useLanguage();
 *   
 *   return (
 *     <button onClick={() => changeLanguage('wo')}>
 *       {language === 'fr' ? 'Passer en Wolof' : 'Passer en FranÃ§ais'}
 *     </button>
 *   );
 * }
 */
export function useLanguage() {
  const context = useContext(LangContext);

  if (context === null) {
    throw new Error('useLanguage doit Ãªtre utilisÃ© Ã  l\'intÃ©rieur d\'un LangProvider');
  }

  return context;
}

export default LangContext;

