// @generated by Cursor AI (Claude) â€” verified by Kevin

import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Loader2, AlertCircle, CheckCircle } from 'lucide-react';
import { authService } from '@/services/authService';
import { authApi } from '@/api/authApi';
import { useAuth } from '@/context/AuthContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import OAuthProfileCompletionModal from '@/components/shared/OAuthProfileCompletionModal';

/**
 * Page de callback OAuth
 * 
 * RÃ´le :
 * - GÃ¨re le callback aprÃ¨s connexion OAuth (Google, etc.)
 * - VÃ©rifie la session crÃ©Ã©e par Supabase
 * - CrÃ©e le profil utilisateur si nouveau user
 * - Redirige vers le dashboard appropriÃ©
 * 
 * Route : /auth/callback
 * 
 * Flow :
 * 1. User clique "Se connecter avec Google" â†’ RedirigÃ© vers Google
 * 2. Google authentifie â†’ Redirige vers /auth/callback?code=...
 * 3. Supabase traite le code â†’ CrÃ©e session
 * 4. Cette page vÃ©rifie session â†’ CrÃ©e profil si nÃ©cessaire â†’ Redirige
 */
function AuthCallback() {
  const { t } = useTranslation();
  const navigate = useNavigate();
  const { checkAuth } = useAuth(); // Pour mettre Ã  jour le contexte aprÃ¨s OAuth

  const [status, setStatus] = useState('processing'); // 'processing' | 'success' | 'error' | 'needsProfile'
  const [error, setError] = useState(null);
  const [user, setUser] = useState(null);
  const [showProfileModal, setShowProfileModal] = useState(false);

  useEffect(() => {
    /**
     * Traiter le callback OAuth
     */
    const handleCallback = async () => {
      try {
        setStatus('processing');

        // GÃ©rer le callback OAuth (vÃ©rifier session, crÃ©er profil si nÃ©cessaire)
        const result = await authService.handleOAuthCallback('fr');

        if (!result.success) {
          setError(result.error || 'Erreur lors de la connexion OAuth');
          setStatus('error');
          return;
        }

        // SuccÃ¨s : Mettre Ã  jour le contexte AuthContext
        await checkAuth();

        // âš ï¸ IMPORTANT : RÃ©cupÃ©rer le profil complet depuis la base de donnÃ©es
        // car result.user peut ne pas avoir toutes les colonnes (ex: age)
        let userProfile = result.user;
        
        // Si c'est un citoyen, rÃ©cupÃ©rer le profil complet pour vÃ©rifier age et commune_id
        if (userProfile?.role === 'citizen') {
          try {
            const { supabase } = await import('@/config/supabase');
            const session = await authApi.getSession();
            
            if (session?.user?.id) {
              const { data: fullProfile, error: profileError } = await supabase
                .from('users')
                .select('id, name, email, role, commune_id, age, phone')
                .eq('id', session.user.id)
                .single();
              
              if (!profileError && fullProfile) {
                userProfile = fullProfile;
              }
            }
          } catch (err) {
            console.warn('Erreur rÃ©cupÃ©ration profil complet:', err);
            // Continuer avec result.user si erreur
          }
        }

        // VÃ©rifier si le profil est complet (pour tous les citoyens, nouveaux ou existants)
        // Un profil est complet si : age ET commune_id ET phone sont dÃ©finis
        const needsCompletion = userProfile?.role === 'citizen' && (!userProfile.age || !userProfile.commune_id || !userProfile.phone);
        
        console.log('ğŸ” VÃ©rification profil:', {
          role: userProfile?.role,
          age: userProfile?.age,
          commune_id: userProfile?.commune_id,
          phone: userProfile?.phone,
          needsCompletion,
        });
        
        if (needsCompletion) {
          // Profil incomplet â†’ Afficher la modal de complÃ©tion
          console.log('ğŸ“ Profil incomplet, affichage de la modal');
          setUser(userProfile);
          setShowProfileModal(true);
          setStatus('needsProfile');
          return;
        }

        // Profil complet ou user existant â†’ Rediriger
        setStatus('success');

        // Si user avec role 'citizen' â†’ Rediriger vers /home (citoyen)
        if (result.user?.role === 'citizen') {
          setTimeout(() => {
            navigate('/home', { replace: true });
          }, 1500);
          return;
        }

        // User avec role (agent/admin) â†’ Rediriger vers dashboard appropriÃ©
        const redirectPath = authService.getRedirectPath(result.user.role);
        setTimeout(() => {
          navigate(redirectPath, { replace: true });
        }, 1500);

      } catch (err) {
        console.error('ğŸ”´ Erreur callback OAuth:', err);
        console.error('ğŸ”´ DÃ©tails:', {
          message: err.message,
          code: err.code,
          details: err.details,
          hint: err.hint,
        });
        
        // En dÃ©veloppement, afficher plus de dÃ©tails
        const errorMessage = process.env.NODE_ENV === 'development'
          ? `Erreur: ${err.message || 'Erreur inconnue'}${err.details ? ` (${err.details})` : ''}`
          : 'Une erreur est survenue. Veuillez rÃ©essayer';
        
        setError(errorMessage);
        setStatus('error');
      }
    };

    // Traiter le callback immÃ©diatement
    handleCallback();
  }, [navigate, checkAuth]);

  /**
   * Callback appelÃ© aprÃ¨s complÃ©tion du profil
   */
  const handleProfileComplete = async (updatedUser) => {
    setShowProfileModal(false);
    setStatus('success');
    await checkAuth(); // RafraÃ®chir le contexte avec le profil complet

    // Rediriger vers /home aprÃ¨s un court dÃ©lai
    setTimeout(() => {
      navigate('/home', { replace: true });
    }, 1500);
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // RENDER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // Modal de complÃ©tion de profil
  if (showProfileModal && user) {
    return (
      <>
        <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
          <Card className="w-full max-w-md">
            <CardContent className="pt-6">
              <div className="flex flex-col items-center space-y-4">
                <CheckCircle className="h-12 w-12 text-success-600" />
                <p className="text-neutral-700 font-medium text-center">
                  {t('oauth.callback.success', { defaultValue: 'Connexion rÃ©ussie !' })}
                </p>
                <p className="text-sm text-neutral-500 text-center">
                  {t('oauth.callback.completingProfile', { defaultValue: 'ComplÃ©tons votre profil...' })}
                </p>
              </div>
            </CardContent>
          </Card>
        </div>
        <OAuthProfileCompletionModal
          open={showProfileModal}
          onComplete={handleProfileComplete}
          user={user}
        />
      </>
    );
  }

  if (status === 'processing') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="flex flex-col items-center space-y-4">
              <Loader2 className="h-12 w-12 animate-spin text-primary-600" />
              <p className="text-neutral-700 font-medium text-center">
                {t('oauth.callback.processing', { defaultValue: 'Connexion en cours...' })}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (status === 'success') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="flex flex-col items-center space-y-4">
              <CheckCircle className="h-12 w-12 text-success-600" />
              <p className="text-neutral-700 font-medium text-center">
                {t('oauth.callback.success', { defaultValue: 'Connexion rÃ©ussie !' })}
              </p>
              <p className="text-sm text-neutral-500 text-center">
                {t('oauth.callback.redirecting', { defaultValue: 'Redirection en cours...' })}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Status = 'error'
  return (
    <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-center">
            {t('oauth.callback.error', { defaultValue: 'Erreur de connexion' })}
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center gap-2 text-error-600">
            <AlertCircle className="h-5 w-5" />
            <p className="text-sm">{error || t('oauth.callback.errorMessage', { defaultValue: 'Impossible de finaliser la connexion' })}</p>
          </div>
          <Button
            onClick={() => navigate('/welcome', { replace: true })}
            className="w-full"
          >
            {t('oauth.callback.backToWelcome', { defaultValue: 'Retour Ã  l\'inscription' })}
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}

export default AuthCallback;

