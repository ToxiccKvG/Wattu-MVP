// @generated by Cursor AI (Claude) â€” verified by Kevin

import { useEffect, useState } from 'react';
import { useNavigate, useSearchParams } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Loader2, AlertCircle, CheckCircle } from 'lucide-react';
import { authApi } from '@/api/authApi';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

/**
 * Page de confirmation d'email
 * 
 * RÃ´le :
 * - VÃ©rifie le token de confirmation depuis l'URL
 * - Confirme le compte utilisateur dans Supabase
 * - Redirige vers la page de connexion
 * 
 * Route : /auth/confirm-email?token=...&type=signup
 * 
 * Flow :
 * 1. User s'inscrit â†’ ReÃ§oit email de confirmation
 * 2. User clique sur le lien â†’ RedirigÃ© vers cette page avec token
 * 3. Cette page vÃ©rifie le token â†’ Confirme le compte
 * 4. Redirige vers /login pour se connecter
 */
function EmailConfirmation() {
  const { t } = useTranslation('common');
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();

  const [status, setStatus] = useState('processing'); // 'processing' | 'success' | 'error'
  const [error, setError] = useState(null);

  useEffect(() => {
    const handleConfirmation = async () => {
      try {
        setStatus('processing');

        const { supabase } = await import('@/config/supabase');

        // Cas 1 : Token_hash dans les query params (template personnalisÃ©)
        const token_hash = searchParams.get('token_hash');
        const type = searchParams.get('type') || 'signup';

        if (token_hash) {
          // VÃ©rifier le token et confirmer l'email
          const { data, error: verifyError } = await supabase.auth.verifyOtp({
            token_hash,
            type,
          });

          if (verifyError) {
            console.error('ðŸ”´ Erreur vÃ©rification token:', verifyError);
            setError(t('emailConfirmation.errors.invalidToken', { defaultValue: 'Token de confirmation invalide ou expirÃ©' }));
            setStatus('error');
            return;
          }

          // SuccÃ¨s : Compte confirmÃ©
          setStatus('success');

          // DÃ©connecter l'utilisateur (il devra se connecter manuellement)
          await supabase.auth.signOut();

          // Rediriger vers la page de connexion aprÃ¨s un court dÃ©lai
          setTimeout(() => {
            navigate('/login', { replace: true });
          }, 2000);
          return;
        }

        // Cas 2 : Supabase a peut-Ãªtre dÃ©jÃ  traitÃ© le hash de l'URL (#access_token=...)
        // Attendre un peu pour que Supabase traite le hash
        await new Promise(resolve => setTimeout(resolve, 1000));

        // VÃ©rifier si une session existe dÃ©jÃ 
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();

        if (sessionError) {
          console.error('ðŸ”´ Erreur rÃ©cupÃ©ration session:', sessionError);
          setError(t('emailConfirmation.errors.invalidToken', { defaultValue: 'Token de confirmation invalide ou expirÃ©' }));
          setStatus('error');
          return;
        }

        if (session && session.user) {
          // Session crÃ©Ã©e = confirmation rÃ©ussie
          console.log('âœ… Session crÃ©Ã©e, compte confirmÃ©');
          setStatus('success');

          // DÃ©connecter l'utilisateur (il devra se connecter manuellement)
          await supabase.auth.signOut();

          // Rediriger vers la page de connexion aprÃ¨s un court dÃ©lai
          setTimeout(() => {
            navigate('/login', { replace: true });
          }, 2000);
          return;
        }

        // Aucun token trouvÃ©
        console.error('ðŸ”´ Aucun token de confirmation trouvÃ© dans l\'URL');
        setError(t('emailConfirmation.errors.noToken', { defaultValue: 'Token de confirmation manquant. Veuillez utiliser le lien dans l\'email de confirmation.' }));
        setStatus('error');

      } catch (err) {
        console.error('ðŸ”´ Erreur confirmation email:', err);
        setError(t('emailConfirmation.errors.unexpected', { defaultValue: 'Une erreur est survenue lors de la confirmation' }));
        setStatus('error');
      }
    };

    handleConfirmation();
  }, [searchParams, navigate, t]);

  if (status === 'processing') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="flex flex-col items-center space-y-4">
              <Loader2 className="h-12 w-12 animate-spin text-primary-600" />
              <p className="text-neutral-700 font-medium text-center">
                {t('emailConfirmation.processing', { defaultValue: 'Confirmation de votre email en cours...' })}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (status === 'success') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="flex flex-col items-center space-y-4">
              <CheckCircle className="h-12 w-12 text-success-600" />
              <p className="text-neutral-700 font-medium text-center">
                {t('emailConfirmation.success', { defaultValue: 'Email confirmÃ© avec succÃ¨s !' })}
              </p>
              <p className="text-sm text-neutral-500 text-center">
                {t('emailConfirmation.redirecting', { defaultValue: 'Redirection vers la page de connexion...' })}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Status = 'error'
  return (
    <div className="min-h-screen flex items-center justify-center bg-neutral-50 p-4">
      <Card className="w-full max-w-md">
        <CardHeader>
          <CardTitle className="text-center">
            {t('emailConfirmation.error', { defaultValue: 'Erreur de confirmation' })}
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center gap-2 text-error-600">
            <AlertCircle className="h-5 w-5" />
            <p className="text-sm">{error || t('emailConfirmation.errors.unexpected', { defaultValue: 'Impossible de confirmer votre email' })}</p>
          </div>
          <Button
            onClick={() => navigate('/login', { replace: true })}
            className="w-full"
          >
            {t('emailConfirmation.backToLogin', { defaultValue: 'Aller Ã  la page de connexion' })}
          </Button>
        </CardContent>
      </Card>
    </div>
  );
}

export default EmailConfirmation;

