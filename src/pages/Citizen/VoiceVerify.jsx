// @generated by Cursor AI (Claude) — verified by [developer name]
/**
 * Page de vérification vocale (Login)
 * 
 * Route : /voice-verify
 * 
 * Processus :
 * 1. Récupérer l'utilisateur vocal depuis localStorage
 * 2. L'utilisateur enregistre sa voix
 * 3. L'audio est comparé avec l'embedding stocké
 * 4. Si match → Redirection vers le dashboard citoyen
 */

import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Mic, MicOff, Loader2, AlertCircle, CheckCircle, User } from 'lucide-react';
import { toast } from 'sonner';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import Logo from '@/components/shared/Logo';
import { useAudioRecording } from '@/hooks/useAudioRecording';
import { voiceAuthApi } from '@/api/voiceAuthApi';

function VoiceVerify() {
  const { t } = useTranslation('common');
  const navigate = useNavigate();

  // États du processus
  const [step, setStep] = useState('record'); // 'record' | 'processing' | 'success' | 'failed'
  const [error, setError] = useState(null);
  const [voiceUser, setVoiceUser] = useState(null);
  const [verificationResult, setVerificationResult] = useState(null);

  // Hook d'enregistrement audio
  const {
    isSupported,
    isRecording,
    duration,
    maxDuration,
    audioBlob,
    error: recordingError,
    volume, // Volume en temps réel (0-1)
    startRecording,
    stopRecording,
    resetRecording,
  } = useAudioRecording({ maxDuration: 5 });

  // Charger l'utilisateur vocal depuis localStorage
  useEffect(() => {
    const storedUser = localStorage.getItem('voiceUser');
    if (storedUser) {
      const user = JSON.parse(storedUser);
      setVoiceUser(user);
    } else {
      // Pas d'utilisateur vocal → Rediriger vers enrôlement
      toast.error('Veuillez d\'abord vous inscrire');
      navigate('/voice-enroll', { replace: true });
    }
  }, [navigate]);

  // Traiter l'audio quand l'enregistrement est terminé
  useEffect(() => {
    if (audioBlob && step === 'record' && voiceUser) {
      handleVerifyVoice();
    }
  }, [audioBlob, voiceUser]);

  /**
   * Envoie l'audio au backend pour vérification
   */
  const handleVerifyVoice = async () => {
    if (!audioBlob || !voiceUser) return;

    setStep('processing');
    setError(null);

    try {
      const result = await voiceAuthApi.verifyVoice(voiceUser.id, audioBlob);

      if (result.success && result.match) {
        // Vérification réussie
        setVerificationResult(result);
        setStep('success');

        // Mettre à jour le statut dans localStorage
        const updatedUser = {
          ...voiceUser,
          authenticated: true,
          lastVerifiedAt: new Date().toISOString(),
        };
        localStorage.setItem('voiceUser', JSON.stringify(updatedUser));

        toast.success(t('voiceAuth.verify.success', { defaultValue: 'Voix reconnue !' }));

        // Rediriger vers le dashboard après 2 secondes
        setTimeout(() => {
          navigate('/home', { replace: true });
        }, 2000);

      } else if (result.success && !result.match) {
        // Voix non reconnue
        setVerificationResult(result);
        setStep('failed');
        setError(t('voiceAuth.verify.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer.' }));
        resetRecording();
      } else {
        // Erreur
        setError(t('voiceAuth.verify.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer.' }));
        setStep('record');
        resetRecording();
      }
    } catch (err) {
      console.error('Erreur vérification:', err);
      setError(t('voiceAuth.verify.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer.' }));
      setStep('record');
      resetRecording();
    }
  };

  /**
   * Recommencer la vérification
   */
  const handleRetry = () => {
    setStep('record');
    setError(null);
    setVerificationResult(null);
    resetRecording();
  };

  /**
   * Formater la durée en mm:ss
   */
  const formatDuration = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Afficher erreur de support navigateur
  if (!isSupported) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-black px-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6 text-center">
            <AlertCircle className="h-12 w-12 text-error-500 mx-auto mb-4" />
            <h2 className="text-lg font-semibold text-neutral-900 mb-2">
              Navigateur non supporté
            </h2>
            <p className="text-sm text-neutral-600">
              Votre navigateur ne supporte pas l'enregistrement audio.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-black px-4 py-8">
      {/* Logo */}
      <div className="mb-6 text-center">
        <div className="flex justify-center mb-4">
          <Logo size="lg" withLink={false} />
        </div>
        <h1 className="text-xl font-bold text-neutral-900">
          {t('voiceAuth.verify.title', { defaultValue: 'Vérification vocale' })}
        </h1>
      </div>

      <Card className="w-full max-w-md shadow-xl border-0">
        <CardHeader className="pb-4">
          <CardTitle className="text-xl text-center font-bold">
            {step === 'record' && t('voiceAuth.verify.title', { defaultValue: 'Confirmez votre voix' })}
            {step === 'processing' && t('voiceAuth.verify.processing', { defaultValue: 'Vérification en cours...' })}
            {step === 'success' && t('voiceAuth.verify.success', { defaultValue: 'Identité confirmée !' })}
            {step === 'failed' && t('voiceAuth.verify.errors.voiceNotRecognized', { defaultValue: 'Voix non reconnue' })}
          </CardTitle>
          {(step === 'processing' || step === 'success' || step === 'failed') && (
          <CardDescription className="text-center">
            {step === 'processing' && t('voiceAuth.verify.processing', { defaultValue: 'Veuillez patienter' })}
            {step === 'success' && t('voiceAuth.verify.redirecting', { defaultValue: 'Redirection en cours...' })}
            {step === 'failed' && t('voiceAuth.verify.retry', { defaultValue: 'Veuillez réessayer' })}
          </CardDescription>
          )}
        </CardHeader>

        <CardContent className="space-y-6 pt-2">
          {/* Info utilisateur */}
          {voiceUser && step === 'record' && (
            <div className="flex items-center gap-3 p-4 bg-gradient-to-br from-blue-50 to-primary-50 rounded-xl border border-blue-200/50">
              <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center">
                <User className="h-6 w-6 text-blue-600" />
              </div>
              <div>
                <p className="font-semibold text-neutral-900 text-base">
                  {voiceUser.prenom} {voiceUser.name}
                </p>
                <p className="text-xs text-neutral-600 mt-0.5">
                  {t('voiceAuth.verify.enrolledAt', { defaultValue: 'Inscrit le' })} {new Date(voiceUser.enrolledAt).toLocaleDateString('fr-FR')}
                </p>
              </div>
            </div>
          )}

          {/* Erreur globale */}
          {(error || recordingError) && (
            <div className="p-3 rounded-lg bg-error-50 border border-error-200 flex items-start gap-2">
              <AlertCircle className="h-5 w-5 text-error-500 flex-shrink-0 mt-0.5" />
              <p className="text-sm text-error-700">
                {error || t('voiceAuth.verify.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer.' })}
              </p>
            </div>
          )}

          {/* Étape 1 : Enregistrement */}
          {step === 'record' && (
            <div className="flex flex-col items-center space-y-8">
              {/* Indicateur de durée */}
              <div className="text-center">
                <p className={`text-4xl font-mono font-bold transition-colors duration-300 ${
                  isRecording ? 'text-red-600' : 'text-neutral-900'
                }`}>
                  {formatDuration(duration)}
                </p>
                <p className="text-xs text-neutral-500 mt-1">
                  max {formatDuration(maxDuration)}
                </p>
              </div>

              {/* Bouton d'enregistrement avec animation de vagues */}
              <div className="relative flex items-center justify-center">
                {/* Cercle animé autour du bouton quand on enregistre */}
                {isRecording && (
                  <>
                    <div className="absolute w-32 h-32 rounded-full bg-red-500/20 animate-ping" />
                    <div className="absolute w-28 h-28 rounded-full bg-red-500/30 animate-pulse" />
                  </>
                )}
                
              <button
                  onClick={async () => {
                    if (isRecording) {
                      stopRecording();
                    } else {
                      const result = await startRecording();
                      if (!result.success && result.error) {
                        setError(t('voiceAuth.verify.errors.microphoneDenied', { defaultValue: 'Impossible de démarrer l\'enregistrement. Vérifiez les permissions du micro.' }));
                      }
                    }
                  }}
                  disabled={recordingError && !isRecording}
                className={`
                    relative w-28 h-28 rounded-full flex items-center justify-center overflow-hidden
                    transition-all duration-300 shadow-xl z-10
                  ${isRecording 
                      ? 'bg-red-500 hover:bg-red-600 scale-110 ring-4 ring-red-500/50' 
                      : 'bg-blue-600 hover:bg-blue-700 hover:scale-105'
                    }
                    ${recordingError && !isRecording ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
                    transform
                  `}
                >
                  {/* Animation de vagues basée sur le volume */}
                  {isRecording && (
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                      {[...Array(3)].map((_, i) => {
                        const baseSize = 28;
                        const waveSize = baseSize + (volume * 50) * (1 + i * 0.4);
                        const baseOpacity = 0.4 - (i * 0.15);
                        const dynamicOpacity = baseOpacity + (volume * 0.3);
                        return (
                          <div
                            key={i}
                            className="absolute rounded-full border-2 border-white"
                            style={{
                              width: `${waveSize}px`,
                              height: `${waveSize}px`,
                              opacity: Math.max(0.1, Math.min(0.7, dynamicOpacity)),
                              transform: `translate(-50%, -50%) scale(${1 + volume * 0.4})`,
                              left: '50%',
                              top: '50%',
                              transition: 'all 0.05s ease-out',
                            }}
                          />
                        );
                      })}
                    </div>
                  )}
                  
                  {/* Icône microphone */}
                  <div className="relative z-10">
                {isRecording ? (
                      <MicOff className="h-12 w-12 text-white" style={{ 
                        transform: `scale(${1 + volume * 0.1})`,
                        transition: 'transform 0.1s ease-out'
                      }} />
                ) : (
                      <Mic className="h-12 w-12 text-white" />
                )}
                  </div>
              </button>
              </div>

              {/* Indicateur visuel d'enregistrement */}
              {isRecording && (
                <div className="flex items-center gap-2 text-red-600">
                  <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                  <p className="text-sm font-medium">
                    {t('voiceAuth.verify.recording', { defaultValue: 'Enregistrement en cours...' })}
                  </p>
                </div>
              )}

              {/* Exemple */}
              <div className="bg-gradient-to-br from-blue-50 to-primary-50 p-5 rounded-xl w-full border-2 border-blue-200/50 shadow-sm">
                <div className="flex items-center justify-center gap-2 mb-2">
                  <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                  <p className="text-xs font-semibold text-blue-700 uppercase tracking-wide">
                    {t('voiceAuth.verify.exampleLabel', { defaultValue: 'Exemple' })}
                  </p>
                  <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                </div>
                <p className="text-base font-medium text-neutral-800 text-center">
                  "{t('voiceAuth.verify.example', { defaultValue: 'Mouhamed Ndiaye' })}"
                </p>
              </div>
            </div>
          )}

          {/* Étape 2 : Traitement */}
          {step === 'processing' && (
            <div className="flex flex-col items-center space-y-4 py-12">
              <div className="relative">
                <Loader2 className="h-16 w-16 text-primary-600 animate-spin" />
                <div className="absolute inset-0 rounded-full border-4 border-primary-100" />
              </div>
              <p className="text-base text-neutral-700 font-medium">
                {t('voiceAuth.verify.processing', { defaultValue: 'Comparaison de votre voix...' })}
              </p>
            </div>
          )}

          {/* Étape 3 : Succès */}
          {step === 'success' && verificationResult && (
            <div className="flex flex-col items-center space-y-4 py-8">
              <div className="w-16 h-16 rounded-full bg-success-100 flex items-center justify-center">
                <CheckCircle className="h-10 w-10 text-success-600" />
              </div>
              <div className="text-center">
                <p className="text-lg font-semibold text-neutral-900">
                  {t('voiceAuth.verify.success', { defaultValue: 'Bienvenue' })} {verificationResult.prenom} !
                </p>
                <p className="text-sm text-neutral-600 mt-2">
                  {t('voiceAuth.verify.redirecting', { defaultValue: 'Redirection en cours...' })}
                </p>
              </div>
              <Loader2 className="h-5 w-5 text-primary-600 animate-spin" />
            </div>
          )}

          {/* Étape 4 : Échec */}
          {step === 'failed' && (
            <div className="flex flex-col items-center space-y-4 py-4">
              <div className="w-16 h-16 rounded-full bg-error-100 flex items-center justify-center">
                <AlertCircle className="h-10 w-10 text-error-600" />
              </div>
              <p className="text-sm text-neutral-600 text-center">
                {error || t('voiceAuth.verify.errors.voiceNotRecognized', { defaultValue: 'Votre voix n\'a pas été reconnue. Veuillez réessayer.' })}
              </p>
              <Button onClick={handleRetry} className="w-full">
                {t('voiceAuth.verify.retry', { defaultValue: 'Réessayer' })}
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Lien retour */}
      <div className="mt-6">
        <Button
          variant="ghost"
          onClick={() => navigate('/welcome')}
        >
          ← Retour
          </Button>
      </div>
    </div>
  );
}

export default VoiceVerify;

