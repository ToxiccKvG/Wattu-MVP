// @generated by Cursor AI (Claude) — verified by [developer name]
/**
 * Page d'enrôlement vocal
 * 
 * Route : /voice-enroll
 * 
 * Processus :
 * 1. L'utilisateur enregistre sa voix (dit son nom et prénom)
 * 2. L'audio est envoyé au backend pour transcription
 * 3. Le compte est créé directement et l'utilisateur est redirigé vers vérification
 */

import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import { Mic, MicOff, Loader2, AlertCircle } from 'lucide-react';
import { toast } from 'sonner';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import Logo from '@/components/shared/Logo';
import { useAudioRecording } from '@/hooks/useAudioRecording';
import { voiceAuthApi } from '@/api/voiceAuthApi';

function VoiceEnroll() {
  const { t } = useTranslation('common');
  const navigate = useNavigate();

  // États du processus
  const [step, setStep] = useState('record'); // 'record' | 'processing' | 'saving'
  const [error, setError] = useState(null);

  // Hook d'enregistrement audio
  const {
    isSupported,
    isRecording,
    duration,
    maxDuration,
    audioBlob,
    error: recordingError,
    volume, // Volume en temps réel (0-1)
    startRecording,
    stopRecording,
    resetRecording,
  } = useAudioRecording({ maxDuration: 5 }); // 5 secondes max pour dire son nom

  // Vérifier si l'API vocale est disponible
  useEffect(() => {
    const checkApi = async () => {
      const isAvailable = await voiceAuthApi.checkVoiceApiHealth();
      if (!isAvailable) {
        setError('Le service d\'authentification vocale n\'est pas disponible. Veuillez réessayer plus tard.');
      }
    };
    checkApi();
  }, []);

  // Traiter l'audio quand l'enregistrement est terminé
  useEffect(() => {
    if (audioBlob && step === 'record' && !isRecording) {
      handleProcessAudio();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [audioBlob, step, isRecording]);

  /**
   * Envoie l'audio au backend pour traitement et création du compte
   */
  const handleProcessAudio = async () => {
    if (!audioBlob) return;

    setStep('processing');
    setError(null);

    try {
      // Étape 1 : Transcription et extraction d'embedding
      const enrollResult = await voiceAuthApi.enrollVoice(audioBlob);

      if (!enrollResult.success) {
        // Erreur lors de l'enrôlement - retour à l'enregistrement
        setError(t('voiceAuth.enroll.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer l\'enregistrement.' }));
        setStep('record');
        resetRecording();
        return;
      }

      // Vérifier que le prénom a été extrait (obligatoire)
      if (!enrollResult.prenom || !enrollResult.prenom.trim()) {
        // Transcription échouée - retour à l'enregistrement
        setError(t('voiceAuth.enroll.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer l\'enregistrement.' }));
      setStep('record');
      resetRecording();
      return;
    }

      // Étape 2 : Création directe du compte
    setStep('saving');

      const confirmResult = await voiceAuthApi.confirmEnrollment({
        temp_user_id: enrollResult.temp_user_id,
        name: (enrollResult.name || '').trim(),
        prenom: enrollResult.prenom.trim(),
        voice_embedding: enrollResult.voice_embedding,
      });

      if (confirmResult.success) {
        // Stocker l'utilisateur vocal dans localStorage
        const voiceUser = {
          id: confirmResult.user_id,
          name: confirmResult.name,
          prenom: confirmResult.prenom,
          authenticated: false, // Pas encore vérifié
          enrolledAt: new Date().toISOString(),
        };
        localStorage.setItem('voiceUser', JSON.stringify(voiceUser));

        toast.success(t('voiceAuth.enroll.accountCreated', { defaultValue: 'Votre compte a été bien créé' }));
        
        // Rediriger vers la page welcome pour qu'il se connecte
        navigate('/welcome', { replace: true });
      } else {
        // Erreur lors de la création du compte - retour à l'enregistrement
        setError(t('voiceAuth.enroll.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer l\'enregistrement.' }));
        setStep('record');
        resetRecording();
      }
    } catch (err) {
      console.error('Erreur traitement audio:', err);
      // Erreur générique - retour à l'enregistrement
      setError(t('voiceAuth.enroll.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer l\'enregistrement.' }));
      setStep('record');
      resetRecording();
    }
  };

  /**
   * Formater la durée en mm:ss
   */
  const formatDuration = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  };

  // Afficher erreur de support navigateur
  if (!isSupported) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-black px-4">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6 text-center">
            <AlertCircle className="h-12 w-12 text-error-500 mx-auto mb-4" />
            <h2 className="text-lg font-semibold text-black mb-2">
              Navigateur non supporté
            </h2>
            <p className="text-sm text-black">
              Votre navigateur ne supporte pas l'enregistrement audio. 
              Veuillez utiliser Chrome, Firefox ou Safari.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-black px-4 py-8">
      {/* Logo */}
      <div className="mb-6 text-center">
        <div className="flex justify-center mb-4">
          <Logo size="lg" withLink={false} />
        </div>
        <h1 className="text-xl font-bold text-white">
          {t('voiceAuth.enroll.title', { defaultValue: 'Inscription vocale' })}
        </h1>
      </div>

      <Card className="w-full max-w-md shadow-xl border-0">
        <CardHeader className="pb-4">
          <CardTitle className="text-xl text-center font-bold text-black">
            {step === 'record' && t('voiceAuth.enroll.instruction', { defaultValue: 'Enregistrez votre voix' })}
            {step === 'processing' && t('voiceAuth.enroll.processing', { defaultValue: 'Analyse en cours...' })}
            {step === 'saving' && t('voiceAuth.enroll.saving', { defaultValue: 'Création du compte...' })}
          </CardTitle>
          {(step === 'processing' || step === 'saving') && (
          <CardDescription className="text-center text-gray-600">
            {step === 'processing' && t('voiceAuth.enroll.processing', { defaultValue: 'Veuillez patienter' })}
            {step === 'saving' && t('voiceAuth.enroll.saving', { defaultValue: 'Veuillez patienter' })}
          </CardDescription>
          )}
        </CardHeader>

        <CardContent className="space-y-6 pt-2">
          {/* Erreur globale */}
          {(error || recordingError) && (
            <div className="p-3 rounded-lg bg-error-50 border border-error-200 flex items-start gap-2">
              <AlertCircle className="h-5 w-5 text-error-500 flex-shrink-0 mt-0.5" />
              <p className="text-sm text-error-700">
                {error || t('voiceAuth.enroll.errors.generic', { defaultValue: 'Une erreur est survenue. Veuillez réessayer l\'enregistrement.' })}
              </p>
            </div>
          )}

          {/* Étape 1 : Enregistrement */}
          {step === 'record' && (
            <div className="flex flex-col items-center space-y-8">
              {/* Indicateur de durée */}
              <div className="text-center">
                <p className={`text-4xl font-mono font-bold transition-colors duration-300 ${
                  isRecording ? 'text-error-600' : 'text-black'
                }`}>
                  {formatDuration(duration)}
                </p>
                <p className="text-xs text-gray-600 mt-1">
                  max {formatDuration(maxDuration)}
                </p>
              </div>

              {/* Bouton d'enregistrement avec animation de vagues */}
              <div className="relative flex items-center justify-center">
                {/* Cercle animé autour du bouton quand on enregistre */}
                {isRecording && (
                  <>
                    <div className="absolute w-32 h-32 rounded-full bg-red-500/20 animate-ping" />
                    <div className="absolute w-28 h-28 rounded-full bg-red-500/30 animate-pulse" />
                  </>
                )}
                
              <button
                onClick={async () => {
                  if (isRecording) {
                    stopRecording();
                  } else {
                    const result = await startRecording();
                    if (!result.success && result.error) {
                      setError(t('voiceAuth.enroll.errors.microphoneDenied', { defaultValue: 'Impossible de démarrer l\'enregistrement. Vérifiez les permissions du micro.' }));
                    }
                  }
                }}
                disabled={recordingError && !isRecording}
                className={`
                    relative w-28 h-28 rounded-full flex items-center justify-center overflow-hidden
                    transition-all duration-300 shadow-xl z-10
                  ${isRecording 
                      ? 'bg-red-500 hover:bg-red-600 scale-110 ring-4 ring-red-500/50' 
                      : 'bg-blue-600 hover:bg-blue-700 hover:scale-105'
                  }
                  ${recordingError && !isRecording ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}
                    transform
                `}
              >
                  {/* Animation de vagues basée sur le volume */}
                  {isRecording && (
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                      {[...Array(3)].map((_, i) => {
                        const baseSize = 28;
                        const waveSize = baseSize + (volume * 50) * (1 + i * 0.4);
                        const baseOpacity = 0.4 - (i * 0.15);
                        const dynamicOpacity = baseOpacity + (volume * 0.3);
                        return (
                          <div
                            key={i}
                            className="absolute rounded-full border-2 border-white"
                            style={{
                              width: `${waveSize}px`,
                              height: `${waveSize}px`,
                              opacity: Math.max(0.1, Math.min(0.7, dynamicOpacity)),
                              transform: `translate(-50%, -50%) scale(${1 + volume * 0.4})`,
                              left: '50%',
                              top: '50%',
                              transition: 'all 0.05s ease-out',
                            }}
                          />
                        );
                      })}
                    </div>
                  )}
                  
                  {/* Icône microphone */}
                  <div className="relative z-10">
                {isRecording ? (
                      <MicOff className="h-12 w-12 text-white" style={{ 
                        transform: `scale(${1 + volume * 0.1})`,
                        transition: 'transform 0.1s ease-out'
                      }} />
                ) : (
                      <Mic className="h-12 w-12 text-white" />
                )}
                  </div>
              </button>
              </div>

              {/* Indicateur visuel d'enregistrement */}
              {isRecording && (
                <div className="flex items-center gap-2 text-red-600">
                  <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                  <p className="text-sm font-medium text-black">
                    {t('voiceAuth.enroll.recording', { defaultValue: 'Enregistrement en cours...' })}
              </p>
                </div>
              )}

              {/* Exemple */}
              <div className="bg-gradient-to-br from-blue-50 to-primary-50 p-5 rounded-xl w-full border-2 border-blue-200/50 shadow-sm">
                <div className="flex items-center justify-center gap-2 mb-2">
                  <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                  <p className="text-xs font-semibold text-blue-700 uppercase tracking-wide">
                    {t('voiceAuth.enroll.exampleLabel', { defaultValue: 'Exemple' })}
                </p>
                  <div className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse" />
                </div>
                <p className="text-base font-medium text-black text-center">
                  "{t('voiceAuth.enroll.example', { defaultValue: 'Mouhamed Ndiaye' })}"
                </p>
              </div>
            </div>
          )}

          {/* Étape 2 : Traitement */}
          {step === 'processing' && (
            <div className="flex flex-col items-center space-y-4 py-12">
              <div className="relative">
                <Loader2 className="h-16 w-16 text-primary-600 animate-spin" />
                <div className="absolute inset-0 rounded-full border-4 border-primary-100" />
              </div>
              <p className="text-base text-black font-medium">
                {t('voiceAuth.enroll.processing', { defaultValue: 'Analyse de votre voix...' })}
              </p>
            </div>
          )}

          {/* Étape 3 : Sauvegarde */}
          {step === 'saving' && (
            <div className="flex flex-col items-center space-y-4 py-12">
              <div className="relative">
                <Loader2 className="h-16 w-16 text-primary-600 animate-spin" />
                <div className="absolute inset-0 rounded-full border-4 border-primary-100" />
              </div>
              <p className="text-base text-black font-medium">
                Création de votre compte...
              </p>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Lien retour */}
      <div className="mt-6">
        <Button
          variant="ghost"
          onClick={() => navigate('/welcome')}
        >
          ← Retour
        </Button>
      </div>
    </div>
  );
}

export default VoiceEnroll;

