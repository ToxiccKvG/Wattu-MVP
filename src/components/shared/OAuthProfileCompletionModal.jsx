// @generated by Cursor AI (Claude) — verified by Kevin

import { useState } from 'react';
import { useTranslation } from 'react-i18next';
import { AlertCircle, Loader2 } from 'lucide-react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useCommunes } from '@/hooks/useCommunes';
import { authService } from '@/services/authService';
import { toast } from 'sonner';

/**
 * Modal de complément de profil après connexion OAuth
 * 
 * Demande à l'utilisateur de compléter son profil avec :
 * - Âge
 * - Commune
 * 
 * Utilisé après une connexion OAuth Google pour collecter
 * les informations manquantes nécessaires à l'application.
 * 
 * @param {boolean} open - État d'ouverture de la modal
 * @param {Function} onComplete - Callback appelé après complétion réussie
 * @param {Object} user - Utilisateur actuel (pour afficher son nom/email)
 */
function OAuthProfileCompletionModal({ open, onComplete, user }) {
  const { t } = useTranslation('common');
  const { communes, loading: communesLoading } = useCommunes();

  const [formData, setFormData] = useState({
    age: '',
    commune_id: '',
    phone: '',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [fieldErrors, setFieldErrors] = useState({});

  const validateForm = () => {
    const errors = {};
    if (!formData.age || formData.age < 1 || formData.age > 120) {
      errors.age = t('oauth.completeProfile.errors.ageRequired', { defaultValue: 'L\'âge est obligatoire (1-120)' });
    }
    if (!formData.commune_id) {
      errors.commune_id = t('oauth.completeProfile.errors.communeRequired', { defaultValue: 'La commune est obligatoire' });
    }
    if (!formData.phone || formData.phone.trim() === '') {
      errors.phone = t('oauth.completeProfile.errors.phoneRequired', { defaultValue: 'Le numéro de téléphone est obligatoire' });
    }

    setFieldErrors(errors);
    return Object.keys(errors).length === 0;
  };

  const handleChange = (field, value) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    setFieldErrors((prev) => ({ ...prev, [field]: null }));
    setError(null);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setError(null);

    if (!validateForm()) {
      toast.error(t('oauth.completeProfile.errors.formInvalid', { defaultValue: 'Veuillez corriger les erreurs du formulaire.' }));
      return;
    }

    setLoading(true);
    try {
      const result = await authService.updateUserProfile({
        age: parseInt(formData.age),
        commune_id: formData.commune_id,
        phone: formData.phone.trim(),
      }, 'fr');

      if (!result.success) {
        setError(result.error || t('oauth.completeProfile.errors.unexpected', { defaultValue: 'Erreur lors de la mise à jour du profil' }));
        toast.error(result.error || t('oauth.completeProfile.errors.unexpected', { defaultValue: 'Erreur lors de la mise à jour du profil' }));
        return;
      }

      toast.success(t('oauth.completeProfile.success', { defaultValue: 'Profil complété avec succès !' }));
      onComplete(result.user);

    } catch (err) {
      console.error('Erreur complétion profil:', err);
      setError(t('oauth.completeProfile.errors.unexpected', { defaultValue: 'Une erreur est survenue. Veuillez réessayer.' }));
      toast.error(t('oauth.completeProfile.errors.unexpected', { defaultValue: 'Une erreur est survenue. Veuillez réessayer.' }));
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={() => {}}>
      <DialogContent className="sm:max-w-md" showCloseButton={false} onPointerDownOutside={(e) => e.preventDefault()} onEscapeKeyDown={(e) => e.preventDefault()}>
        <DialogHeader>
          <DialogTitle>
            {t('oauth.completeProfile.title', { defaultValue: 'Complétez votre profil' })}
          </DialogTitle>
          <DialogDescription>
            {t('oauth.completeProfile.description', { 
              defaultValue: 'Quelques informations supplémentaires sont nécessaires pour finaliser votre inscription.',
              name: user?.name || user?.email?.split('@')[0] || 'Utilisateur'
            })}
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit} className="space-y-4">
          {/* Âge */}
          <div className="space-y-2">
            <Label htmlFor="age">
              {t('oauth.completeProfile.age', { defaultValue: 'Âge' })} *
            </Label>
            <Input
              id="age"
              type="number"
              min="1"
              max="120"
              placeholder={t('oauth.completeProfile.agePlaceholder', { defaultValue: 'Votre âge' })}
              value={formData.age}
              onChange={(e) => handleChange('age', e.target.value)}
              disabled={loading || communesLoading}
              aria-invalid={!!fieldErrors.age}
            />
            {fieldErrors.age && (
              <p className="text-sm text-error-600 flex items-center gap-1">
                <AlertCircle className="h-4 w-4" />
                {fieldErrors.age}
              </p>
            )}
          </div>

          {/* Commune */}
          <div className="space-y-2">
            <Label htmlFor="commune">
              {t('oauth.completeProfile.commune', { defaultValue: 'Commune' })} *
            </Label>
            <Select
              value={formData.commune_id}
              onValueChange={(value) => handleChange('commune_id', value)}
              disabled={loading || communesLoading}
            >
              <SelectTrigger id="commune" aria-invalid={!!fieldErrors.commune_id} className="w-full">
                <SelectValue placeholder={t('oauth.completeProfile.communePlaceholder', { defaultValue: 'Sélectionnez votre commune' })} />
              </SelectTrigger>
              <SelectContent 
                className="z-[1002] !z-[1002]"
                style={{ zIndex: 1002 }}
              >
                {communes.map((commune) => (
                  <SelectItem key={commune.id} value={commune.id}>
                    {commune.name} ({commune.region})
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {fieldErrors.commune_id && (
              <p className="text-sm text-error-600 flex items-center gap-1">
                <AlertCircle className="h-4 w-4" />
                {fieldErrors.commune_id}
              </p>
            )}
          </div>

          {/* Numéro de téléphone */}
          <div className="space-y-2">
            <Label htmlFor="phone">
              {t('oauth.completeProfile.phone', { defaultValue: 'Numéro de téléphone' })} *
            </Label>
            <Input
              id="phone"
              type="tel"
              placeholder={t('oauth.completeProfile.phonePlaceholder', { defaultValue: 'Votre numéro de téléphone' })}
              value={formData.phone}
              onChange={(e) => handleChange('phone', e.target.value)}
              disabled={loading || communesLoading}
              aria-invalid={!!fieldErrors.phone}
            />
            {fieldErrors.phone && (
              <p className="text-sm text-error-600 flex items-center gap-1">
                <AlertCircle className="h-4 w-4" />
                {fieldErrors.phone}
              </p>
            )}
          </div>

          {/* Erreur globale */}
          {error && (
            <div className="p-3 rounded-lg bg-error-50 border border-error-200">
              <p className="text-sm text-error-700 flex items-center gap-2">
                <AlertCircle className="h-4 w-4 flex-shrink-0" />
                {error}
              </p>
            </div>
          )}

          {/* Bouton de soumission */}
          <Button
            type="submit"
            className="w-full"
            disabled={loading || communesLoading}
          >
            {loading ? (
              <>
                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                {t('oauth.completeProfile.submitting', { defaultValue: 'Enregistrement...' })}
              </>
            ) : (
              t('oauth.completeProfile.submit', { defaultValue: 'Continuer' })
            )}
          </Button>
        </form>
      </DialogContent>
    </Dialog>
  );
}

export default OAuthProfileCompletionModal;

